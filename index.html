<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Integration Flow Name Updater</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Inter', 'Segoe UI', 'Helvetica Neue', sans-serif;
            background: radial-gradient(circle at top, #0f172a 0, #020617 40%, #000000 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            position: relative;
            overflow: hidden;
            color: #e5e7eb;
        }

        body::before {
            content: '';
            position: fixed;
            inset: -100px;
            background:
                radial-gradient(circle at 10% 0%, rgba(34,197,94,0.25) 0, transparent 50%),
                radial-gradient(circle at 90% 100%, rgba(16,185,129,0.25) 0, transparent 55%),
                radial-gradient(circle at 50% 50%, rgba(5,150,105,0.12) 0, transparent 60%);
            filter: blur(8px);
            opacity: 0.9;
            z-index: 0;
        }

        .container {
            background: rgba(15, 23, 42, 0.78);
            backdrop-filter: blur(32px) saturate(180%);
            -webkit-backdrop-filter: blur(32px) saturate(180%);
            border-radius: 24px;
            padding: 40px 32px 26px;
            max-width: 780px;
            width: 100%;
            position: relative;
            z-index: 1;
            border: 1px solid rgba(148, 163, 184, 0.35);
            box-shadow:
                0 0 0 1px rgba(15, 23, 42, 0.9),
                0 18px 60px rgba(0, 0, 0, 0.85),
                0 0 40px rgba(34, 197, 94, 0.35);
            overflow: hidden;
        }

        .container::before {
            content: '';
            position: absolute;
            inset: -2px;
            border-radius: 24px;
            background:
                conic-gradient(from 180deg,
                    rgba(16,185,129,0.0),
                    rgba(22,163,74,0.9),
                    rgba(22,163,74,0.0),
                    rgba(22,163,74,0.9),
                    rgba(16,185,129,0.0));
            mix-blend-mode: screen;
            opacity: 0.3;
            filter: blur(18px);
            pointer-events: none;
            z-index: -1;
            animation: neon-rotate 12s linear infinite;
        }

        @keyframes neon-rotate { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        h1 {
            text-align: center;
            margin-bottom: 16px;
            font-size: 26px;
            letter-spacing: 0.02em;
            font-weight: 700;
            background: linear-gradient(120deg, #bbf7d0, #4ade80, #22c55e);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .subtitle {
            text-align: center;
            font-size: 13px;
            color: #9ca3af;
            margin-bottom: 20px;
        }

        #drop-area {
            border-radius: 18px;
            padding: 26px 22px;
            text-align: center;
            cursor: pointer;
            background: radial-gradient(circle at top left, rgba(34,197,94,0.15), transparent 60%),
                        rgba(15,23,42,0.85);
            border: 1px solid rgba(55,65,81,0.8);
            transition: all 0.25s ease;
            position: relative;
            overflow: hidden;
        }

        #drop-area::before {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: inherit;
            background: linear-gradient(135deg,
                    rgba(34,197,94,0.75),
                    rgba(22,163,74,0.25),
                    rgba(22,163,74,0.75));
            opacity: 0;
            transition: opacity 0.25s ease;
            mix-blend-mode: screen;
            pointer-events: none;
        }

        #drop-area.highlight {
            border-color: rgba(34,197,94,0.9);
            box-shadow:
                0 0 0 1px rgba(22,163,74,0.7),
                0 0 40px rgba(22,163,74,0.65);
            transform: translateY(-1px) scale(1.01);
        }

        #drop-area.highlight::before { opacity: 0.2; }

        .upload-icon {
            font-size: 38px;
            margin-bottom: 8px;
            text-shadow: 0 0 16px rgba(22,163,74,0.7);
        }

        .upload-text { font-size: 16px; color: #e5e7eb; margin-bottom: 4px; font-weight: 500; }
        .upload-hint { font-size: 12px; color: #9ca3af; }

        #file-input { display: none; }

        .file-label {
            display: inline-block;
            margin-top: 14px;
            padding: 9px 18px;
            border-radius: 999px;
            border: 1px solid rgba(148,163,184,0.9);
            font-size: 12px;
            font-weight: 500;
            letter-spacing: 0.04em;
            text-transform: uppercase;
            color: #e5e7eb;
            background: radial-gradient(circle at top, rgba(148,163,184,0.25), transparent 60%);
            backdrop-filter: blur(10px);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .file-label:hover {
            border-color: rgba(34,197,94,0.9);
            box-shadow: 0 0 18px rgba(22,163,74,0.7);
            color: #bbf7d0;
            transform: translateY(-1px);
        }

        .actions {
            margin-top: 20px;
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 10px;
        }

        .action-btn {
            padding: 9px 12px;
            border-radius: 12px;
            border: 1px solid rgba(55,65,81,0.9);
            background: radial-gradient(circle at top, rgba(15,23,42,0.95), rgba(2,6,23,0.95));
            color: #e5e7eb;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            transition: all 0.2s ease;
            box-shadow: 0 12px 30px rgba(0,0,0,0.7);
            text-align: center;
        }

        .action-btn.primary {
            border-color: rgba(34,197,94,0.9);
            box-shadow:
                0 0 0 1px rgba(22,163,74,0.7),
                0 10px 30px rgba(22,163,74,0.45);
            background: radial-gradient(circle at top, rgba(22,163,74,0.4), rgba(5,46,22,0.98));
        }

        .action-btn.danger {
            border-color: rgba(239,68,68,0.9);
            background: radial-gradient(circle at top, rgba(127,29,29,0.7), rgba(15,23,42,0.95));
            box-shadow:
                0 0 0 1px rgba(127,29,29,0.9),
                0 10px 30px rgba(127,29,29,0.6);
        }

        .action-btn:hover {
            transform: translateY(-1px);
            border-color: rgba(34,197,94,0.85);
            box-shadow:
                0 0 0 1px rgba(22,163,74,0.9),
                0 14px 35px rgba(22,163,74,0.55);
        }

        .action-btn.danger:hover {
            border-color: rgba(239,68,68,0.95);
            box-shadow:
                0 0 0 1px rgba(239,68,68,0.95),
                0 14px 35px rgba(239,68,68,0.7);
        }

        .action-btn:active {
            transform: translateY(0);
            box-shadow:
                0 0 0 1px rgba(22,163,74,0.7),
                0 8px 20px rgba(22,163,74,0.45);
        }

        .action-btn:disabled {
            opacity: 0.45;
            cursor: not-allowed;
            box-shadow: none;
            border-color: rgba(55,65,81,0.6);
        }

        #bundle-panel {
            margin-top: 18px;
            padding: 12px 14px;
            border-radius: 14px;
            border: 1px solid rgba(55,65,81,0.9);
            background: rgba(15,23,42,0.9);
            font-size: 12px;
            display: none;
        }

        #bundle-panel-label {
            color: #9ca3af;
            margin-bottom: 6px;
        }

        #bundle-input {
            width: 100%;
            padding: 8px 9px;
            border-radius: 9px;
            border: 1px solid rgba(55,65,81,0.9);
            background: rgba(15,23,42,0.95);
            color: #e5e7eb;
            font-size: 12px;
            outline: none;
            transition: all 0.2s ease;
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        }

        #bundle-input:focus {
            border-color: rgba(34,197,94,0.9);
            box-shadow: 0 0 0 1px rgba(22,163,74,0.9);
        }

        #status {
            margin-top: 16px;
            padding: 12px 14px;
            border-radius: 14px;
            font-size: 12px;
            display: none;
            border: 1px solid rgba(55,65,81,0.9);
            background: rgba(15,23,42,0.95);
        }

        .status-info {
            border-color: rgba(59,130,246,0.9);
            background: radial-gradient(circle at top, rgba(59,130,246,0.22), rgba(15,23,42,0.96));
            color: #dbeafe;
        }

        .status-success {
            border-color: rgba(34,197,94,0.9);
            background: radial-gradient(circle at top, rgba(34,197,94,0.22), rgba(6,24,15,0.97));
            color: #bbf7d0;
        }

        .status-error {
            border-color: rgba(239,68,68,0.9);
            background: radial-gradient(circle at top, rgba(239,68,68,0.22), rgba(30,7,7,0.97));
            color: #fecaca;
        }

        .status-warning {
            border-color: rgba(245,158,11,0.9);
            background: radial-gradient(circle at top, rgba(245,158,11,0.25), rgba(24,20,5,0.97));
            color: #fef3c7;
        }

        .processing-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .spinner {
            border: 3px solid rgba(148,163,184,0.22);
            border-top: 3px solid rgba(34,197,94,0.95);
            border-radius: 999px;
            width: 18px;
            height: 18px;
            animation: spin 0.8s linear infinite;
        }

        .processing-text { font-size: 12px; }

        .progress-bar-container {
            margin-top: 6px;
            width: 100%;
            height: 4px;
            border-radius: 999px;
            background: rgba(15,23,42,0.95);
            overflow: hidden;
            border: 1px solid rgba(31,41,55,0.9);
        }

        .progress-bar {
            height: 100%;
            width: 0%;
            border-radius: inherit;
            background: linear-gradient(90deg, #22c55e, #4ade80, #bbf7d0);
            box-shadow: 0 0 16px rgba(34,197,94,0.9);
            transition: width 0.25s ease;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        @media (max-width: 640px) {
            .container { padding: 28px 20px 18px; border-radius: 20px; }
            h1 { font-size: 22px; }
            .actions { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
<div class="container">
    <h1>Integration Flow Name Updater</h1>
    <p class="subtitle">Upload your CPI IFlow ZIP and update MANIFEST.MF names safely.</p>

    <div id="drop-area">
        <div class="upload-icon">ðŸ“¦</div>
        <p class="upload-text">Drop your ZIP file here</p>
        <p class="upload-hint">or click below to browse</p>
        <label for="file-input" class="file-label" onclick="event.stopPropagation();">Choose ZIP File</label>
    </div>

    <input type="file" id="file-input" accept=".zip">

    <div id="bundle-panel">
        <div id="bundle-panel-label">Bundle-Name (editable):</div>
        <input id="bundle-input" type="text" placeholder="Bundle-Name will appear here after loading the ZIP">
    </div>

    <div class="actions">
        <button class="action-btn primary" id="btn-remove-dev">
            Remove <code>_DEV</code>
        </button>
        <button class="action-btn" id="btn-replace-dev-qs4">
            Replace <code>_DEV</code> â†’ <code>_QS4-110</code>
        </button>
        <button class="action-btn danger" id="btn-remove-qs4">
            Remove <code>_QS4-110</code>
        </button>
        <button class="action-btn primary" id="btn-custom-bundle">
            Custom Bundle-Name Replace
        </button>
    </div>

    <div id="status"></div>
</div>

<script>
    const dropArea = document.getElementById('drop-area');
    const fileInput = document.getElementById('file-input');
    const statusEl = document.getElementById('status');
    const btnRemoveDev = document.getElementById('btn-remove-dev');
    const btnReplaceDevQs4 = document.getElementById('btn-replace-dev-qs4');
    const btnRemoveQs4 = document.getElementById('btn-remove-qs4');
    const btnCustomBundle = document.getElementById('btn-custom-bundle');
    const bundlePanel = document.getElementById('bundle-panel');
    const bundleInput = document.getElementById('bundle-input');

    let currentFile = null;

    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropArea.addEventListener(eventName, preventDefaults, false);
        document.body.addEventListener(eventName, preventDefaults, false);
    });

    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }

    ['dragenter', 'dragover'].forEach(eventName => {
        dropArea.addEventListener(eventName, () => {
            dropArea.classList.add('highlight');
        }, false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
        dropArea.addEventListener(eventName, () => {
            dropArea.classList.remove('highlight');
        }, false);
    });

    dropArea.addEventListener('drop', (e) => {
        const dt = e.dataTransfer;
        const files = dt.files;
        handleFiles(files);
    }, false);

    fileInput.addEventListener('change', (e) => {
        handleFiles(e.target.files);
    });

    dropArea.addEventListener('click', (e) => {
        if (e.target.tagName !== 'LABEL' && !e.target.closest('label')) {
            fileInput.click();
        }
    });

    function handleFiles(files) {
        if (!files || files.length === 0) {
            showStatus('Please select a ZIP file.', 'error');
            setStateNoFile();
            return;
        }

        const file = files[0];

        if (!file.name.endsWith('.zip')) {
            showStatus('Only ZIP files are supported.', 'error');
            setStateNoFile();
            return;
        }

        currentFile = file;
        showStatus(`File loaded: ${file.name}`, 'info');
        toggleActionButtons(true);
        preloadManifest(file);
    }

    function setStateNoFile() {
        currentFile = null;
        bundlePanel.style.display = 'none';
        bundleInput.value = '';
        toggleActionButtons(false);
    }

    function toggleActionButtons(enabled) {
        [btnRemoveDev, btnReplaceDevQs4, btnRemoveQs4, btnCustomBundle].forEach(btn => {
            btn.disabled = !enabled;
        });
    }

    async function preloadManifest(file) {
        try {
            const arrayBuffer = await file.arrayBuffer();
            const zip = await JSZip.loadAsync(arrayBuffer, { checkCRC32: true, createFolders: true });

            const manifestPath = 'META-INF/MANIFEST.MF';
            const manifestFile = zip.file(manifestPath);

            if (!manifestFile) {
                showStatus('MANIFEST.MF not found under META-INF.', 'warning');
                bundlePanel.style.display = 'none';
                bundleInput.value = '';
                return;
            }

            const content = await manifestFile.async('string');
            const normalizedContent = normalizeManifest(content);
            const bundleName = extractBundleNameValue(normalizedContent);
            if (bundleName) {
                bundleInput.value = bundleName;
                bundlePanel.style.display = 'block';
            } else {
                bundleInput.value = '';
                bundlePanel.style.display = 'none';
            }

        } catch (e) {
            console.error('Error preloading manifest:', e);
            showStatus('Error reading MANIFEST.MF for preview: ' + e.message, 'warning');
            bundlePanel.style.display = 'none';
            bundleInput.value = '';
        }
    }

    // Normalize manifest: unwrap continuation lines to make single lines per property
    function normalizeManifest(content) {
        return content.replace(/(\r?\n) +/g, '');
    }

    // Re-wrap manifest lines to maintain 72-byte limit per JAR spec
    function rewrapManifest(content) {
        const lineBreak = content.includes('\r\n') ? '\r\n' : '\n';
        const lines = content.split(/\r?\n/);
        const wrapped = [];
        
        for (const line of lines) {
            if (line.length <= 72) {
                wrapped.push(line);
            } else {
                // Split line at 72 bytes for first line, then 71 bytes for continuation lines (space takes 1 byte)
                let remaining = line;
                let isFirst = true;
                
                while (remaining.length > 0) {
                    if (isFirst) {
                        wrapped.push(remaining.substring(0, 72));
                        remaining = remaining.substring(72);
                        isFirst = false;
                    } else {
                        if (remaining.length > 71) {
                            wrapped.push(' ' + remaining.substring(0, 71));
                            remaining = remaining.substring(71);
                        } else {
                            wrapped.push(' ' + remaining);
                            remaining = '';
                        }
                    }
                }
            }
        }
        
        return wrapped.join(lineBreak);
    }

    // Extract the logical Bundle-Name value (single line, trimmed)
    function extractBundleNameValue(content) {
        const bundleMatch = content.match(/^Bundle-Name:\s*(.+)$/m);
        return bundleMatch ? bundleMatch[1].trim() : null;
    }

    // Count ALL occurrences of bundle value after normalization
    function findAllBundleNameOccurrences(content, bundleValue) {
        const normalizedContent = normalizeManifest(content);
        const escapedValue = bundleValue.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        const regex = new RegExp(escapedValue, 'g');
        return (normalizedContent.match(regex) || []).length;
    }

    btnRemoveDev.addEventListener('click', () => {
        if (!currentFile) {
            showStatus('Please upload a ZIP file first.', 'warning');
            return;
        }
        processZipFile(currentFile, 'removeDev');
    });

    btnReplaceDevQs4.addEventListener('click', () => {
        if (!currentFile) {
            showStatus('Please upload a ZIP file first.', 'warning');
            return;
        }
        processZipFile(currentFile, 'replaceDevQs4');
    });

    btnRemoveQs4.addEventListener('click', () => {
        if (!currentFile) {
            showStatus('Please upload a ZIP file first.', 'warning');
            return;
        }
        processZipFile(currentFile, 'removeQs4');
    });

    btnCustomBundle.addEventListener('click', () => {
        if (!currentFile) {
            showStatus('Please upload a ZIP file first.', 'warning');
            return;
        }
        processZipFile(currentFile, 'customBundle');
    });

    async function processZipFile(file, mode) {
        showProcessing('Preparing your file...');
        toggleActionButtons(false);

        try {
            await updateProgress(20, 'Reading ZIP file...');
            const arrayBuffer = await file.arrayBuffer();

            await updateProgress(45, 'Loading archive...');
            const zip = await JSZip.loadAsync(arrayBuffer, {
                checkCRC32: true,
                createFolders: true
            });

            await updateProgress(60, 'Locating MANIFEST.MF...');
            const manifestPath = 'META-INF/MANIFEST.MF';
            const manifestFile = zip.file(manifestPath);

            if (!manifestFile) {
                hideProcessing();
                showStatus('MANIFEST.MF not found under META-INF.', 'error');
                toggleActionButtons(true);
                return;
            }

            const originalFileObj = zip.files[manifestPath];

            await updateProgress(70, 'Reading manifest...');
            let originalContent = await manifestFile.async('string');
            
            await updateProgress(75, 'Normalizing manifest...');
            let normalizedContent = normalizeManifest(originalContent);
            let updatedContent = normalizedContent;
            let successMessage = '';

            if (mode === 'removeDev') {
                const devCount = (normalizedContent.match(/_DEV/g) || []).length;
                if (devCount === 0) {
                    hideProcessing();
                    showStatus('No occurrences of _DEV found in MANIFEST.MF.', 'warning');
                    toggleActionButtons(true);
                    return;
                }
                await updateProgress(85, 'Removing ALL _DEV occurrences...');
                updatedContent = normalizedContent.replace(/_DEV/g, '');
                successMessage = `${devCount} occurrence(s) of _DEV removed from ALL locations`;
            }

            if (mode === 'replaceDevQs4') {
                const devCount = (normalizedContent.match(/_DEV/g) || []).length;
                if (devCount === 0) {
                    hideProcessing();
                    showStatus('No occurrences of _DEV found in MANIFEST.MF.', 'warning');
                    toggleActionButtons(true);
                    return;
                }
                await updateProgress(85, 'Replacing ALL _DEV with _QS4-110...');
                updatedContent = normalizedContent.replace(/_DEV/g, '_QS4-110');
                successMessage = `${devCount} occurrence(s) of _DEV â†’ _QS4-110 (ALL locations)`;
            }

            if (mode === 'removeQs4') {
                const qs4Count = (normalizedContent.match(/_QS4-110/g) || []).length;
                if (qs4Count === 0) {
                    hideProcessing();
                    showStatus('No occurrences of _QS4-110 found in MANIFEST.MF.', 'warning');
                    toggleActionButtons(true);
                    return;
                }
                await updateProgress(85, 'Removing ALL _QS4-110 occurrences...');
                updatedContent = normalizedContent.replace(/_QS4-110/g, '');
                successMessage = `${qs4Count} occurrence(s) of _QS4-110 removed from ALL locations`;
            }

            if (mode === 'customBundle') {
                await updateProgress(80, 'Analyzing Bundle-Name...');
                
                const oldBundleValue = extractBundleNameValue(normalizedContent);
                const newBundleValue = (bundleInput.value || '').trim();
                
                if (!oldBundleValue) {
                    hideProcessing();
                    showStatus('No Bundle-Name found in MANIFEST.MF.', 'warning');
                    toggleActionButtons(true);
                    return;
                }
                
                if (!newBundleValue) {
                    hideProcessing();
                    showStatus('New Bundle-Name cannot be empty. Edit it in the input box.', 'error');
                    toggleActionButtons(true);
                    return;
                }

                const occurrences = findAllBundleNameOccurrences(originalContent, oldBundleValue);
                if (occurrences === 0) {
                    hideProcessing();
                    showStatus('Original Bundle-Name not found for replacement.', 'warning');
                    toggleActionButtons(true);
                    return;
                }

                await updateProgress(90, `Replacing ${occurrences} Bundle-Name occurrences...`);
                
                // Replace ALL occurrences in normalized content
                const escapedOldValue = oldBundleValue.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                updatedContent = normalizedContent.replace(new RegExp(escapedOldValue, 'g'), newBundleValue);
                
                successMessage = `${occurrences} occurrence(s) replaced (ALL 4 locations)`;
            }

            // Re-wrap the manifest to maintain proper format
            await updateProgress(93, 'Re-wrapping manifest lines...');
            const finalContent = rewrapManifest(updatedContent);

            await finalizeZip(
                zip,
                manifestPath,
                originalFileObj,
                finalContent,
                file,
                successMessage
            );

        } catch (error) {
            console.error('Error processing ZIP:', error);
            hideProcessing();
            showStatus('Error: ' + error.message, 'error');
            toggleActionButtons(true);
        }
    }

    function bundleNameToSafeFileName(bundleName) {
        if (!bundleName) return null;
        const safe = bundleName
            .replace(/[\\\/:*?"<>|]/g, '_')
            .replace(/\s+/g, '_')
            .replace(/_{2,}/g, '_')
            .slice(0, 150);
        return safe || null;
    }

    async function finalizeZip(zip, manifestPath, originalFileObj, updatedContent, file, successMessage) {
        await updateProgress(96, 'Building updated ZIP...');

        zip.file(manifestPath, updatedContent, {
            binary: false,
            date: originalFileObj.date,
            unixPermissions: originalFileObj.unixPermissions,
            dosPermissions: originalFileObj.dosPermissions,
            createFolders: false,
            comment: originalFileObj.comment
        });

        const blob = await zip.generateAsync({
            type: 'blob',
            compression: 'DEFLATE',
            compressionOptions: { level: 6 },
            mimeType: 'application/zip'
        });

        const normalizedForFileName = normalizeManifest(updatedContent);
        const updatedBundleName = extractBundleNameValue(normalizedForFileName);
        let newFileName;
        const safeFromBundle = bundleNameToSafeFileName(updatedBundleName);

        if (safeFromBundle) {
            newFileName = safeFromBundle + '.zip';
        } else {
            let base = file.name;
            if (!base.toLowerCase().endsWith('.zip')) base += '.zip';
            const dotIndex = base.toLowerCase().lastIndexOf('.zip');
            newFileName = base.slice(0, dotIndex) + '_updated.zip';
        }

        await updateProgress(100, 'Finalizing download...');
        await new Promise(r => setTimeout(r, 250));

        downloadBlob(blob, newFileName);

        hideProcessing();
        showStatus('âœ“ ' + successMessage + '. Downloaded as: ' + newFileName, 'success');
        toggleActionButtons(true);
        fileInput.value = '';
        setStateNoFile();
    }

    function showProcessing(text) {
        statusEl.style.display = 'block';
        statusEl.className = 'status-info';
        statusEl.innerHTML = `
            <div class="processing-container">
                <div class="spinner"></div>
                <div>
                    <div class="processing-text">${text}</div>
                    <div class="progress-bar-container">
                        <div class="progress-bar" id="progress-bar"></div>
                    </div>
                </div>
            </div>
        `;
    }

    function hideProcessing() {
        statusEl.style.display = 'none';
    }

    async function updateProgress(percent, text) {
        const bar = document.getElementById('progress-bar');
        const processingText = statusEl.querySelector('.processing-text');
        if (bar) {
            bar.style.width = percent + '%';
        }
        if (processingText && text) {
            processingText.textContent = text;
        }
        await new Promise(r => setTimeout(r, 160));
    }

    function downloadBlob(blob, filename) {
        const properBlob = new Blob([blob], { type: 'application/zip' });
        const url = URL.createObjectURL(properBlob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        a.style.display = 'none';
        document.body.appendChild(a);
        a.click();
        setTimeout(() => {
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }, 250);
    }

    function showStatus(message, type) {
        statusEl.style.display = 'block';
        statusEl.textContent = message;
        statusEl.className = '';
        statusEl.classList.add('status-' + type);
    }

    toggleActionButtons(false);
</script>
</body>
</html>
